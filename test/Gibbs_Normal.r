######################################## TITLE: GIBBS_NORMAL.R# PURPOSE: ILLUSTRATE GIBBS SAMPLING FOR NORMAL DATA##################################### THE MODEL IS X|mu,sigma~N(mu,sigma), and the joint prior for (mu,sigma^2) is# g(mu,sigma^2) prop to 1/sigma&2 (flat prior for mu, Jeffreys prior for sigma^2 )# the function sample1 takes a starting value for sigma (sg) as input, samples "mu" from# the conditional distribution of mu|sigma,X, and then, with this new "mu", samples a# value from sigma^2|mu,X.  it returns the samplessample1 = function(X,sg) {N = length(X)mu = rnorm(1,mean(X),sg/sqrt(N))sg = sqrt(sum((X-mu)^2)/rchisq(1,N))list(mu=mu,sg=sg)}samplen = function(X,n=1000,sg=1) {mus = rep(NaN,n)sgs = rep(NaN,n)for(i in 1:n) {z = sample1(X,sg)mus[i] = z$musgs[i] = sg = z$sg}# results(mus,sgs) # display resultsinvisible(list(mus=mus,sgs=sgs))} # end function 'samplen'N=15mu=3sigma=5X = rnorm(N,mu,sigma) #mean 3, sd 5     burnin=1     sgstart=1z=samplen(X,n=1500,sgstart)   # what happens if i use a very large starting value?  e.g. sg=1000000.mus=z$mus[burnin:length(z$mus)]sgs=z$sgs[burnin:length(z$sgs)]quantile(mus,c(.025,.5,.975))quantile(sgs,c(.025,.5,.975))if (FALSE) {hist(mus,50) #mu marginalhist(sgs,50) #sd marginalmean(mus) #posterior mean for mumean(sgs) #posterior mean for sigmaplot(z$mus) #look at sequenceplot(z$sgs) #look at sequence }######### HERE WE MAKE SOME COOL PLOTS OF THE POSTERIOR ###############library(MASS)  # need this package for kde2d function ###### FOLLOWING CODE FROM JEFF GILLS BOOK.  PLOT SHOWS HOW SAMPLER MOVES THROUGH POSTERIOR SPACEplot.walk.G<- function(walk.mat,X=1,Y=2) { plot(walk.mat[1,X],walk.mat[1,Y],type="n",  xlim=range(walk.mat[,X]),  ylim=range(walk.mat[,Y]), xlab="",ylab="",main="Mixing")      for ( i in 1:(nrow(walk.mat)-1)) {      segments(walk.mat[i,X],walk.mat[i,Y],                 walk.mat[(i+1),X],walk.mat[i,Y])                 segments(walk.mat[(i+1),X],walk.mat[i,Y],                 walk.mat[(i+1),X],walk.mat[(i+1),Y])                 } # end for loop                 } # end function 'plot.walk.G  # USE FIRST 50 INTERATIONS FROM CHAIN (BURNIN ALREADY DISCARDED)  m1=mus[1:50]  s1=sgs[1:50]      par(mfrow=c(1,2),mar=c(2,3,1,1),oma=c(1,1,3,1))      plot.walk.G(cbind(m1,s1) )      mtext(outer=T,side=2,cex=1.3,expression(sigma))      mtext(outer=F,side=1,cex=1.3,expression(mu),line=2)f2 <- kde2d(mus, sgs, n = 75 ) persp(f2, phi = 15, theta = 60, d = 5,ticktype='detailed',main="Posterior for mu and sigma",xlab=expression(mu) , ylab=expression(sigma), zlab='Density',col="lightgreen") #image(f2, zlim = c(0, 0.05))   par(mfrow=c(2,1),mar=c(2,3,1,1),oma=c(1,1,3,1)) # trace plot     plot(seq(1,length(mus)),mus,type="l",main="Trace plot for mu")        # trace plot     plot(seq(1,length(sgs)),sgs,type="l",main="Trace plot for sigma")          ################### ANALYSIS USING WINBUGS ###################  ## IN THIS EXAMPLE WE USE A DIFFUSE NORMAL PRIOR ON MU AND AN  ## INVERSE GAMMA PRIOR ON SIGMA, I.E. WE USE ESSENTIALLY THE FLAT  #  PRIOR FOR MU AND JEFFREYS PRIOR FOR SIGMA  ############################################library("arm")  #will load  package for running WINbugs from Rsetwd("M:/work/courses/bayes course/spring2009/R programs")# DATA HAVE ALREADY BEEN GENERATED ABOVE data <- list(  "X", "N" )    # inits = NULL   parameters <- c("mu", "tau", "sigma")  # NOTE: HERE RANDOM STARTING VALUES ARE USED FOR ALL VARIABLES.  # USING RANDOM INITIAL VALUES SLOWS	inits = function () {    	         list( mu=rnorm(1), tau=runif(1) ) }    print(date())   normal.sim <- bugs(data, inits, parameters, "normal.bug", n.chains=3, n.iter=2000,   bugs.directory="c:/WinBUGS14/",debug=T,working.directory="M:/work/courses/bayes course/spring2009/R programs")     print(normal.sim,digits=3)     plot(normal.sim, display.parallel = F)  attach.bugs(normal.sim)  ########## CREATE 3-DIMENSIONAL PLOT OF POSTERIOR DENSITY ###############par(mfrow=c(1,1))  f3 <- kde2d(mu, sigma, n = 75 ) z2=persp(f3, phi = 15, theta = 60, d = 5,ticktype='detailed',main="Posterior for mu and sigma",xlab=expression(mu) , ylab=expression(sigma), zlab='Density',col="lightgreen") # image(f3, zlim = c(0, 0.05))   ###### FOLLOWING CODE FROM GILLS BOOK FOR PLOTTING HOW SAMPLER MOVES THROUGH POSTERIOR SPACE  plot.walk.G<- function(walk.mat,X=1,Y=2) { plot(walk.mat[1,X],walk.mat[1,Y],type="n",  xlim=range(walk.mat[,X]),  ylim=range(walk.mat[,Y]), xlab="",ylab="",main="Mixing")      for ( i in 1:(nrow(walk.mat)-1)) {      segments(walk.mat[i,X],walk.mat[i,Y],                 walk.mat[(i+1),X],walk.mat[i,Y])                 segments(walk.mat[(i+1),X],walk.mat[i,Y],                 walk.mat[(i+1),X],walk.mat[(i+1),Y])                 } # end for loop                 } # end function 'plot.walk.G  # USE FIRST 50 INTERATIONS FROM CHAIN (BURNIN ALREADY DISCARDED)  m1=mu[1:50]  s1=sigma[1:50]      par(mfrow=c(1,2),mar=c(2,3,1,1),oma=c(1,1,3,1))      plot.walk.G(cbind(m1,s1) )      mtext(outer=T,side=2,cex=1.3,expression(sigma))      mtext(outer=F,side=1,cex=1.3,expression(mu),line=2) 